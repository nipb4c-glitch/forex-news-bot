name: Forex News Bot

on:
  schedule:
    - cron: '*/10 * * * *'  # Ù‡Ø± Û±Û° Ø¯Ù‚ÛŒÙ‚Ù‡ Ø§Ø¬Ø±Ø§ Ø´ÙˆØ¯
  workflow_dispatch:  # Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ

jobs:
  check-news:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 pytz
        
    - name: Create bot script
      run: |
        cat > forex_bot.py << 'EOF'
import requests
import os
from datetime import datetime, timedelta
from bs4 import BeautifulSoup
import pytz

BOT_TOKEN = os.environ['BOT_TOKEN']
CHAT_ID = os.environ['CHAT_ID']

class ForexBot:
    def __init__(self):
        self.token = BOT_TOKEN
        self.chat_id = CHAT_ID
        self.processed_events = set()
        
    def send_message(self, text):
        """Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù…"""
        url = f"https://api.telegram.org/bot{self.token}/sendMessage"
        data = {
            "chat_id": self.chat_id,
            "text": text,
            "parse_mode": "HTML"
        }
        try:
            response = requests.post(url, json=data, timeout=10)
            print(f"âœ… Ù¾ÛŒØ§Ù… Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯: {text}")
            return response.json()
        except Exception as e:
            print(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…: {e}")
            return None
    
    def get_forex_events(self):
        """Ø¯Ø±ÛŒØ§ÙØª Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ Ø§Ø² Forex Factory"""
        try:
            headers = {
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
            }
            
            response = requests.get("https://www.forexfactory.com/", headers=headers, timeout=10)
            soup = BeautifulSoup(response.content, 'html.parser')
            events = []
            
            # Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø¬Ø¯ÙˆÙ„ Ø§Ø®Ø¨Ø§Ø±
            rows = soup.find_all('tr', class_='calendar__row')
            
            for row in rows:
                try:
                    # Ø¨Ø±Ø±Ø³ÛŒ Ø²Ù…Ø§Ù† Ø±ÙˆÛŒØ¯Ø§Ø¯
                    time_cell = row.find('td', class_='calendar__time')
                    if not time_cell:
                        continue
                    
                    time_text = time_cell.get_text(strip=True)
                    if not time_text or time_text in ['All Day', 'Tentative', 'Later']:
                        continue
                    
                    # Ø¯Ø±ÛŒØ§ÙØª Ø¬Ø²Ø¦ÛŒØ§Øª Ø±ÙˆÛŒØ¯Ø§Ø¯
                    currency_cell = row.find('td', class_='calendar__currency')
                    event_cell = row.find('td', class_='calendar__event')
                    
                    if currency_cell and event_cell:
                        currency = currency_cell.get_text(strip=True)
                        event_name = event_cell.get_text(strip=True)
                        
                        # ÙÙ‚Ø· Ø§Ø®Ø¨Ø§Ø± Ù…Ù‡Ù…
                        important_events = ['NFP', 'CPI', 'Interest Rate', 'GDP', 'Employment', 'FOMC', 'PMI']
                        if any(word in event_name for word in important_events):
                            event_time = self.parse_time(time_text)
                            if event_time:
                                event_id = f"{event_time.strftime('%H:%M')}_{currency}_{event_name}"
                                
                                events.append({
                                    'id': event_id,
                                    'time': event_time,
                                    'currency': currency,
                                    'event': event_name,
                                    'time_text': time_text
                                })
                                
                except Exception as e:
                    continue
                    
            return events
            
        except Exception as e:
            print(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø®Ø¨Ø§Ø±: {e}")
            return []
    
    def parse_time(self, time_str):
        """ØªØ¨Ø¯ÛŒÙ„ Ø²Ù…Ø§Ù† Ø¨Ù‡ ÙØ±Ù…Øª datetime"""
        try:
            now = datetime.now()
            time_str_clean = time_str.replace('am', '').replace('pm', '').strip()
            
            if ':' in time_str_clean:
                hour, minute = map(int, time_str_clean.split(':'))
            else:
                hour = int(time_str_clean)
                minute = 0
            
            # ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ 24-hour format
            if 'pm' in time_str.lower() and hour < 12:
                hour += 12
            elif 'am' in time_str.lower() and hour == 12:
                hour = 0
            
            event_time = datetime.now().replace(
                hour=hour, minute=minute, second=0, microsecond=0
            )
            
            # Ø§Ú¯Ø± Ø²Ù…Ø§Ù† Ú¯Ø°Ø´ØªÙ‡ Ø§Ø³ØªØŒ Ø¨Ø±Ø§ÛŒ ÙØ±Ø¯Ø§ Ø¯Ø± Ù†Ø¸Ø± Ø¨Ú¯ÛŒØ±ÛŒØ¯
            if event_time < now:
                event_time += timedelta(days=1)
            
            return event_time
            
        except Exception as e:
            print(f"âŒ Ø®Ø·Ø§ Ø¯Ø± ØªØ¨Ø¯ÛŒÙ„ Ø²Ù…Ø§Ù†: {e}")
            return None
    
    def check_news(self):
        """Ø¨Ø±Ø±Ø³ÛŒ Ùˆ Ø§Ø±Ø³Ø§Ù„ Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§"""
        print(f"ğŸ” Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø®Ø¨Ø§Ø± Ø¯Ø± {datetime.now().strftime('%H:%M:%S')}")
        
        events = self.get_forex_events()
        now = datetime.now()
        
        for event in events:
            event_id = event['id']
            
            # Ø§Ú¯Ø± Ø±ÙˆÛŒØ¯Ø§Ø¯ Ù‚Ø¨Ù„Ø§Ù‹ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù†Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
            if event_id not in self.processed_events:
                # Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø²Ù…Ø§Ù† Ù‡Ø´Ø¯Ø§Ø± (Û±Û° Ø¯Ù‚ÛŒÙ‚Ù‡ Ù‚Ø¨Ù„)
                alert_time = event['time'] - timedelta(minutes=10)
                
                # Ø§Ú¯Ø± Ø²Ù…Ø§Ù† ÙØ¹Ù„ÛŒ Ù†Ø²Ø¯ÛŒÚ© Ø¨Ù‡ Ø²Ù…Ø§Ù† Ù‡Ø´Ø¯Ø§Ø± Ø§Ø³Øª
                time_diff = (alert_time - now).total_seconds()
                if -60 <= time_diff <= 60:  # Ø¯Ø± Û± Ø¯Ù‚ÛŒÙ‚Ù‡ Ú¯Ø°Ø´ØªÙ‡ ÛŒØ§ Ø¢ÛŒÙ†Ø¯Ù‡
                    message = self.format_message(event)
                    self.send_message(message)
                    self.processed_events.add(event_id)
                    print(f"âš ï¸ Ù‡Ø´Ø¯Ø§Ø± Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯ Ø¨Ø±Ø§ÛŒ: {event['event']}")
                else:
                    print(f"â° Ø±ÙˆÛŒØ¯Ø§Ø¯ Ù¾ÛŒØ¯Ø§ Ø´Ø¯: {event['event']} Ø¯Ø± {event['time_text']}")
    
    def format_message(self, event):
        """ÙØ±Ù…Øªâ€ŒØ¯Ù‡ÛŒ Ù¾ÛŒØ§Ù… Ø¨Ø±Ø§ÛŒ ØªÙ„Ú¯Ø±Ø§Ù…"""
        message = f"""
ğŸ“Š <b>Forex Factory Alert</b>

ğŸ’° <b>Currency:</b> {event['currency']}
ğŸ“… <b>Event:</b> {event['event']}
â° <b>Time:</b> {event['time_text']} (EST)
ğŸ”„ <b>In:</b> 10 minutes

âš ï¸ <b>Get ready for market movement!</b>
        """
        return message.strip()

# Ø§Ø¬Ø±Ø§ÛŒ Ø±Ø¨Ø§Øª
if __name__ == "__main__":
    bot = ForexBot()
    print("ğŸ¤– Ø±Ø¨Ø§Øª Forex Factory Ø´Ø±ÙˆØ¹ Ø¨Ù‡ Ú©Ø§Ø± Ú©Ø±Ø¯...")
    bot.check_news()
    print("âœ… Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø®Ø¨Ø§Ø± Ú©Ø§Ù…Ù„ Ø´Ø¯")
EOF
        
    - name: Run Forex Bot
      env:
        BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
        CHAT_ID: ${{ secrets.CHAT_ID }}
      run: python forex_bot.py
      
    - name: Show log
      run: |
        echo "âœ… Workflow completed successfully"
        date
